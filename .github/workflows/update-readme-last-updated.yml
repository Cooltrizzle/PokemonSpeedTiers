name: Update README last updated

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Set timestamp (UTC)
        run: |
          echo "TIMESTAMP=$(date -u +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_ENV

      - name: Replace placeholder in README (python)
        run: |
          set -eo pipefail
          FILE="README.md"
          START="<!-- LAST_UPDATED:START -->"
          END="<!-- LAST_UPDATED:END -->"
          NEWLINE="Last updated: $TIMESTAMP"

          if [ ! -f "$FILE" ]; then
            echo "$FILE not found, creating minimal README with markers"
            cat > "$FILE" <<EOF
# Project Title

$START
$END
EOF
          fi

          echo "Before replacement (first 20 lines):"
          head -n 20 "$FILE" || true

          python3 - <<PY
import io,sys
fn = "README.md"
start = "<!-- LAST_UPDATED:START -->"
end = "<!-- LAST_UPDATED:END -->"
new = "Last updated: ${TIMESTAMP}"
with io.open(fn, "r", encoding="utf-8") as f:
    s = f.read()
if start in s and end in s:
    prefix, rest = s.split(start,1)
    between, suffix = rest.split(end,1)
    s2 = prefix + start + "\n" + new + "\n" + end + suffix
else:
    # if markers missing, append them at end
    s2 = s.rstrip() + "\n\n" + start + "\n" + new + "\n" + end + "\n"
with io.open(fn, "w", encoding="utf-8") as f:
    f.write(s2)
print("Replacement done")
PY

          echo "After replacement (first 20 lines):"
          head -n 20 "$FILE" || true

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "$FILE"
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore(readme): update last updated timestamp"
            git push origin HEAD:main
          fi
