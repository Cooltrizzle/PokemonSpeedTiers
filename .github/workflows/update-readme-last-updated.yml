- name: Checkout
  uses: actions/checkout@v4
  with:
    persist-credentials: true

- name: Set timestamp
  id: ts
  run: |
    # choose one format â€” uncomment the one you prefer

    # ISO date only (UTC)
    # echo "TIMESTAMP=$(date -u +'%Y-%m-%d')" >> $GITHUB_ENV

    # ISO date + time (UTC)
    echo "TIMESTAMP=$(date -u +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_ENV

    # Human friendly local time (example: NZDT). Replace TZ if needed.
    # echo "TIMESTAMP=$(TZ='Pacific/Auckland' date +'%Y-%m-%d %H:%M %Z')" >> $GITHUB_ENV

- name: Replace placeholder in README
  run: |
    FILE=README.md
    START='<!-- LAST_UPDATED:START -->'
    END='<!-- LAST_UPDATED:END -->'
    NEWLINE="Last updated: $TIMESTAMP"
    # ensure file exists
    if [ ! -f "$FILE" ]; then echo "$FILE not found"; exit 1; fi

    # Replace the block between markers with the single NEWLINE line
    awk -v s="$START" -v e="$END" -v n="$NEWLINE" '
      BEGIN {in=0}
      { if ($0 ~ s) { print; print n; in=1; next }
        if ($0 ~ e) { print; in=0; next }
        if (!in) print
      }' "$FILE" > "$FILE.tmp"
    mv "$FILE.tmp" "$FILE"

    git config user.name "github-actions[bot]"
    git config user.email "github-actions[bot]@users.noreply.github.com"
    git add "$FILE"
    git commit -m "chore(readme): update last updated timestamp" || echo "No changes to commit"
    git push origin HEAD:main
